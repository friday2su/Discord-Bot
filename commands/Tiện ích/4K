const { SlashCommandBuilder } = require('@discordjs/builders');
const { EmbedBuilder, AttachmentBuilder } = require('discord.js');
const axios = require('axios');
const fs = require('fs-extra');
const path = require('path');

const cachePath = './cache';

module.exports = {
    data: new SlashCommandBuilder()
        .setName('4K')
        .setDescription('Reply ảnh để tăng độ phân giải.'),
    async execute(interaction) {
        // Kiểm tra người dùng có reply tin nhắn không
        if (!interaction.repliedMessage || !interaction.repliedMessage.attachments || interaction.repliedMessage.attachments.size === 0) {
            return interaction.reply('⚠️ Bạn cần reply vào một tin nhắn có hình ảnh.');
        }

        const attachment = interaction.repliedMessage.attachments.first();

        // Kiểm tra nếu đính kèm không phải là ảnh
        if (!attachment.contentType.startsWith('image/')) {
            return interaction.reply('❌ Tin nhắn bạn reply không phải là hình ảnh.');
        }

        try {
            // Gọi API để tăng độ phân giải
            const response = await axios.get(`https://4k-ayoub.vercel.app/upscale?url=${encodeURIComponent(attachment.url)}`, {
                responseType: 'arraybuffer',
            });

            if (response.status !== 200) {
                return interaction.reply('❌ Đã xảy ra lỗi khi xử lý hình ảnh.');
            }

            // Đảm bảo thư mục cache tồn tại
            await fs.ensureDir(cachePath);

            // Lưu ảnh kết quả vào file tạm
            const filePath = path.join(cachePath, `${Date.now()}-4k.png`);
            await fs.outputFile(filePath, response.data);

            // Gửi lại ảnh đã nâng cao độ phân giải cho người dùng
            const enhancedImage = new AttachmentBuilder(filePath, { name: 'enhanced-image.png' });
            await interaction.reply({ content: '✅ Hình ảnh đã được nâng cao chất lượng!', files: [enhancedImage] });

            // Xóa file tạm sau khi gửi
            setTimeout(() => fs.unlinkSync(filePath), 60000); // Xóa sau 1 phút
        } catch (error) {
            console.error(error);
            await interaction.reply('❌ Đã xảy ra lỗi khi thực thi lệnh.');
        }
    },
};
